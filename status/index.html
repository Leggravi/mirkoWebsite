---
layout: default
title: Status
permalink: /status/
---

<h1>Status — Bilderübersicht</h1>
<div id="image-list">Lade Bilder…</div>

<script>
// ----------------------------------------------------
// ALLE DATEIEN SAMMELN
// ----------------------------------------------------
var RAW_FILES = [
{% assign first = true %}
{% for f in site.static_files %}
  {% if f.path contains '/assets/img/status/' %}
    {% unless first %},{% endunless %}
    {
      url: {{ f.path | relative_url | jsonify }},
      name: {{ f.name | jsonify }},
      ext: {{ f.extname | jsonify }}
    }
    {% assign first = false %}
  {% endif %}
{% endfor %}
];

const mediaExt = [".jpg",".jpeg",".png",".webp",".gif",".mp4",".mov",".webm"];

// ----------------------------------------------------
// TXT + Preview Finder
// ----------------------------------------------------
function findMatchingTxt(baseName) {
    return RAW_FILES.find(f => f.name === baseName + ".txt");
}

function findPreview(file) {
    const previewName = "preview_" + file.name;
    return RAW_FILES.find(f => f.name === previewName);
}

// ----------------------------------------------------
// TXT PARSER
// ----------------------------------------------------
async function loadTxt(url) {
    try {
        const t = await fetch(url).then(r => r.text());
        const lines = t.split("\n").map(l => l.trim());
        return {
            title: lines.find(l => l.startsWith("Titel:"))?.replace("Titel:","").trim() || "",
            desc:  lines.find(l => l.startsWith("Beschreibung:"))?.replace("Beschreibung:","").trim() || "",
            date:  lines.find(l => l.startsWith("Datum:")) ? new Date(lines.find(l => l.startsWith("Datum:")).replace("Datum:","").trim()) : null
        };
    } catch {
        return {title:"", desc:"", date:null};
    }
}

// ----------------------------------------------------
// Viewer
// ----------------------------------------------------
function createOverlay(){
  const overlay = document.createElement("div");
  overlay.id = "viewer-overlay";
  overlay.style.cssText = `
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.8);
    display: none; justify-content: center; align-items: center;
    z-index: 9999; padding: 20px;
    color: white;
  `;
  overlay.addEventListener("click",()=>overlay.style.display="none");

  const box = document.createElement("div");
  box.id = "viewer-content";
  box.style.maxWidth = "90%";
  box.style.maxHeight = "90%";
  box.style.textAlign = "center";

  const title = document.createElement("h2");
  title.id = "viewer-title";

  const desc = document.createElement("p");
  desc.id = "viewer-desc";

  const media = document.createElement("div");
  media.id = "viewer-media";

  box.appendChild(title);
  box.appendChild(desc);
  box.appendChild(media);

  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function openViewer(file) {
    const overlay = document.getElementById("viewer-overlay");
    const titleEl = document.getElementById("viewer-title");
    const descEl  = document.getElementById("viewer-desc");
    const media   = document.getElementById("viewer-media");

    titleEl.textContent = file.title;
    descEl.textContent  = file.desc;

    media.innerHTML = "";

    if (file.ext.match(/\.mp4|\.mov|\.webm/)) {
        const v = document.createElement("video");
        v.src = file.url;
        v.controls = true;
        v.autoplay = true;
        v.style.maxWidth = "100%";
        v.style.maxHeight = "80vh";
        media.appendChild(v);
    } else {
        const img = document.createElement("img");
        img.src = file.url;
        img.style.maxWidth = "100%";
        img.style.maxHeight = "80vh";
        media.appendChild(img);
    }
    overlay.style.display = "flex";
}

// ----------------------------------------------------
// DATUM
// ----------------------------------------------------
function pad(n){ return n<10 ? "0"+n : n; }
function formatGerman(d){
    if(!d) return "Kein Datum";
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function buildDateHeader(d){
    const now = new Date();
    const diffDays = Math.floor((now - d) / (1000*60*60*24));

    if (diffDays === 0) return "Heute";
    if (diffDays === 1) return "Gestern";

    const months = ["Januar","Februar","März","April","Mai","Juni",
        "Juli","August","September","Oktober","November","Dezember"];

    return months[d.getMonth()] + " " + d.getFullYear();
}

// ----------------------------------------------------
// RENDER
// ----------------------------------------------------
async function render(){
    createOverlay();

    const list = document.getElementById("image-list");
    list.innerHTML = "Lade…";

    // **IMPORTANT: Previews ausschließen**
    let items = RAW_FILES.filter(f =>
        mediaExt.includes(f.ext.toLowerCase()) &&
        !f.name.startsWith("preview_")
    );

    const enriched = [];
    for (const file of items) {
        const txt = findMatchingTxt(file.name);
        const meta = txt ? await loadTxt(txt.url) : {title:"",desc:"",date:null};
        const preview = findPreview(file);

        enriched.push({
            url: file.url,
            name: file.name,
            ext: file.ext.toLowerCase(),
            title: meta.title,
            desc: meta.desc,
            date: meta.date,
            previewUrl: preview ? preview.url : file.url
        });
    }

    enriched.sort((a,b)=>{
        if(a.date && b.date) return b.date - a.date;
        if(a.date) return -1;
        if(b.date) return 1;
        return a.name.localeCompare(b.name);
    });

    list.innerHTML = "";

    let lastGroup = "";

    enriched.forEach(file=>{
        const group = file.date ? buildDateHeader(file.date) : "Ohne Datum";

        if(group !== lastGroup){
            lastGroup = group;
            const h = document.createElement("h2");
            h.textContent = group;
            h.style.marginTop = "2rem";
            list.appendChild(h);
        }

        const card = document.createElement("div");
        card.style.border = "1px solid #ddd";
        card.style.padding = "8px";
        card.style.borderRadius = "8px";
        card.style.cursor = "pointer";
        card.style.display = "inline-block";
        card.style.width = "200px";
        card.style.marginRight = "1rem";

        let preview;

        if(file.ext.match(/\.mp4|\.mov|\.webm/)){
            preview = document.createElement("video");
            preview.src = file.previewUrl;
            preview.muted = true;
        } else {
            preview = document.createElement("img");
            preview.src = file.previewUrl;
        }

        preview.style.width = "100%";
        preview.style.height = "140px";
        preview.style.objectFit = "cover";
        preview.style.borderRadius = "6px";

        const title = document.createElement("div");
        title.textContent = file.title || file.name;
        title.style.fontWeight = "bold";
        title.style.marginTop = "6px";
        title.style.fontSize = "0.9rem";

        const date = document.createElement("div");
        date.textContent = formatGerman(file.date);
        date.style.fontSize = "0.8rem";
        date.style.color = "#666";

        card.appendChild(preview);
        card.appendChild(title);
        card.appendChild(date);

        card.addEventListener("click",()=>openViewer(file));

        list.appendChild(card);
    });
}

document.addEventListener("DOMContentLoaded", render);
</script>
