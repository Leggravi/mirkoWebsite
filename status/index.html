---
layout: default
title: Status
permalink: /status/
---

<h1>Status — Bilderübersicht</h1>
<div id="image-list">Lade Bilder…</div>
<script>
// ----------------------------------------------------
// BILDER + VIDEOS SAMMELN (ohne Endung anzeigen)
// ----------------------------------------------------
var FILES = [
{% assign first = true %}
{% for f in site.static_files %}
  {% if f.path contains '/assets/img/' 
        and (f.extname == '.png' or f.extname == '.jpg' or f.extname == '.jpeg' or f.extname == '.webp' or f.extname == '.mp4' or f.extname == '.mov' or f.extname == '.webm') %}
    {% unless first %},{% endunless %}
    {
      url: {{ f.path | relative_url | jsonify }},
      name: {{ f.name | split: "." | first | jsonify }},
      ext: {{ f.extname | jsonify }}
    }
    {% assign first = false %}
  {% endif %}
{% endfor %}
];
  
// ----------------------------------------------------
// HILFSFUNKTIONEN
// ----------------------------------------------------
function pad(n){ return n<10 ? '0'+n : ''+n; }
function formatGerman(d){
  if(!d) return "Kein Datum";
  return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${(d.getFullYear()+"").slice(-2)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

async function probeLastModified(url){
  try{
    const res = await fetch(url, {method:"HEAD"});
    const lm = res.headers.get("last-modified");
    return lm ? new Date(lm) : null;
  }catch{
    return null;
  }
}

// ----------------------------------------------------
// EXIF für Bilder
// ----------------------------------------------------
async function getExifDate(url){
  try{
    const res = await fetch(url);
    const buffer = await res.arrayBuffer();
    const tags = ExifReader.load(buffer);

    const candidates = [
      "DateTimeOriginal",
      "CreateDate",
      "DateTimeDigitized",
      "ModifyDate",
      "DateTime"
    ];

    for(const c of candidates){
      if(tags[c] && tags[c].description){
        const clean = tags[c].description.replace(/^(\d{4}):(\d{2}):/, "$1-$2-");
        const d = new Date(clean);
        if(!isNaN(d)) return d;
      }
    }
  }catch{}
  return null;
}

// ----------------------------------------------------
// DATUM HERAUSFINDEN (Bild → EXIF, Video → Modified)
// ----------------------------------------------------
async function getFileDate(file){
  const url = file.url;

  // Try EXIF only for images
  if(file.ext !== '.mp4' && file.ext !== '.mov' && file.ext !== '.webm'){
    const exif = await getExifDate(url);
    if(exif) return exif;
  }

  // Fallback: server last-modified
  return await probeLastModified(url);
}

// ----------------------------------------------------
// GRUPPIERUNG
// ----------------------------------------------------
function groupFor(date){
  if(!date) return "Ohne Datum";

  const now = new Date();
  const oneDay = 24*60*60*1000;

  if(date.toDateString() === now.toDateString()) return "Heute";

  const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate()-1);
  if(date.toDateString() === yesterday.toDateString()) return "Gestern";

  if(date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear())
    return "Dieser Monat";

  return `${pad(date.getMonth()+1)}/${date.getFullYear()}`;
}

// ----------------------------------------------------
// OVERLAY (groß anzeigen)
// ----------------------------------------------------
function createOverlay(){
  const overlay = document.createElement("div");
  overlay.id = "viewer-overlay";
  overlay.style.cssText = `
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.8);
    display: none; justify-content: center; align-items: center;
    z-index: 9999; padding: 20px;
  `;
  overlay.addEventListener("click", ()=> overlay.style.display = "none");

  const content = document.createElement("div");
  content.id = "viewer-content";
  content.style.maxWidth = "90%";
  content.style.maxHeight = "90%";

  overlay.appendChild(content);
  document.body.appendChild(overlay);
}

function openViewer(file){
  const overlay = document.getElementById("viewer-overlay");
  const content = document.getElementById("viewer-content");

  content.innerHTML = "";

  if(file.ext === ".mp4" || file.ext === ".mov" || file.ext === ".webm"){
    const v = document.createElement("video");
    v.src = file.url;
    v.controls = true;
    v.autoplay = true;
    v.style.maxWidth = "100%";
    v.style.maxHeight = "90vh";
    content.appendChild(v);
  } else {
    const img = document.createElement("img");
    img.src = file.url;
    img.style.maxWidth = "100%";
    img.style.maxHeight = "90vh";
    content.appendChild(img);
  }

  overlay.style.display = "flex";
}

// ----------------------------------------------------
// HAUPTRENDER
// ----------------------------------------------------
async function render(){
  createOverlay();

  const list = document.getElementById("image-list");
  list.innerHTML = "";

  const enriched = await Promise.all(
    FILES.map(async f => {
      const date = await getFileDate(f);
      return {...f, date};
    })
  );

  enriched.sort((a,b)=>{
    if(a.date && b.date) return b.date - a.date;
    if(a.date) return -1;
    if(b.date) return 1;
    return a.name.localeCompare(b.name);
  });

  const groups = {};
  enriched.forEach(f=>{
    const g = groupFor(f.date);
    if(!groups[g]) groups[g] = [];
    groups[g].push(f);
  });

  // Render
  for(const g in groups){
    const h = document.createElement("h2");
    h.textContent = g;
    h.style.marginTop = "2rem";
    list.appendChild(h);

    const grid = document.createElement("div");
    grid.style.display = "grid";
    grid.style.gridTemplateColumns = "repeat(auto-fill, minmax(200px,1fr))";
    grid.style.gap = "1rem";
    list.appendChild(grid);

    groups[g].forEach(file=>{
      const card = document.createElement("div");
      card.style.border = "1px solid #ddd";
      card.style.padding = "8px";
      card.style.borderRadius = "8px";
      card.style.cursor = "pointer";

      let preview;

      if(file.ext === ".mp4" || file.ext === ".mov" || file.ext === ".webm"){
        preview = document.createElement("video");
        preview.src = file.url;
        preview.muted = true;
        preview.style.height = "140px";
        preview.style.width = "100%";
        preview.style.objectFit = "cover";
      } else {
        preview = document.createElement("img");
        preview.src = file.url;
        preview.style.height = "140px";
        preview.style.width = "100%";
        preview.style.objectFit = "cover";
      }

      const name = document.createElement("div");
      name.textContent = file.name;
      name.style.fontSize = "0.85rem";

      const date = document.createElement("div");
      date.textContent = formatGerman(file.date);
      date.style.color = "#666";
      date.style.fontSize = "0.8rem";

      card.appendChild(preview);
      card.appendChild(name);
      card.appendChild(date);

      card.addEventListener("click", ()=> openViewer(file));

      grid.appendChild(card);
    });
  }
}

document.addEventListener("DOMContentLoaded", render);
</script>
